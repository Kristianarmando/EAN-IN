<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Escala de autoevaluaci√≥n del nivel de conocimiento en habilidades de investigaci√≥n cient√≠fica (EAN-IN)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Librer√≠a para generar PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body { margin: 0; background: #f4f6fb; color: #222; }
    .app-container { display: flex; min-height: 100vh; }
    .sidebar { width: 310px; background: #111827; color: #e5e7eb; padding: 20px 18px; display: flex; flex-direction: column; gap: 16px; }
    .sidebar h1 { font-size: 1.1rem; margin: 0 0 6px; color: #f9fafb; }
    .sidebar small { color: #9ca3af; display: block; margin-bottom: 4px; }
    .credits { font-size: 0.8rem; line-height: 1.3; color: #d1d5db; }
    .credits strong { color: #f9fafb; }
    .credits a { color: #60a5fa; text-decoration: none; }
    .credits a:hover { text-decoration: underline; }
    .section-tabs-title { margin-top: 10px; font-size: 0.9rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #9ca3af; }
    .section-tabs { display: flex; flex-direction: column; gap: 6px; margin-top: 6px; }
    .tab-button { padding: 8px 10px; font-size: 0.85rem; border-radius: 6px; border: 1px solid rgba(156, 163, 175, 0.5); background: #111827; color: #e5e7eb; text-align: left; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.15s ease-in-out; }
    .tab-button:hover { border-color: #60a5fa; background: #1f2937; }
    .tab-button.active { border-color: #3b82f6; background: #1d4ed8; color: #f9fafb; box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.6); }
    .tab-button.completed { background: #047857; border-color: #10b981; color: #ecfdf5; }
    .tab-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 999px; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(148, 163, 184, 0.7); }
    .tab-button.completed .tab-badge { background: rgba(16, 185, 129, 0.2); border-color: rgba(187, 247, 208, 0.9); }
    .main { flex: 1; padding: 20px 26px; overflow-y: auto; }
    .instructions { margin-bottom: 12px; }
    .instructions h2 { margin: 0 0 4px; font-size: 1.05rem; }
    .instructions p { margin: 2px 0; font-size: 0.9rem; }
    .options-list { margin: 4px 0 0 18px; font-size: 0.9rem; }
    .section-title-main { font-size: 1rem; font-weight: 600; margin: 14px 0 10px; color: #111827; display: none; }
    .items-grid { display: none; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; margin-bottom: 16px; }
    .item-card { background: #ffffff; border-radius: 10px; border: 1px solid #e5e7eb; padding: 10px 10px 8px; font-size: 0.9rem; box-shadow: 0 1px 2px rgba(15, 23, 42, 0.06); transition: all 0.15s ease-in-out; }
    .item-card.answered { background: #ecfdf3; border-color: #22c55e; box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.4); }
    .item-card.missing { border-color: #f97373; background: #fef2f2; box-shadow: 0 0 0 1px rgba(248, 113, 113, 0.5); }
    .item-label { margin-bottom: 4px; }
    .item-label span { font-weight: 600; color: #111827; }
    select.item-select { width: 100%; padding: 6px 8px; border-radius: 6px; border: 1px solid #d1d5db; font-size: 0.85rem; background-color: #f9fafb; transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out; }
    select.item-select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.5); background-color: #ffffff; }
    .actions { margin-top: 8px; display: none; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: flex-start; }
    .primary-btn { padding: 8px 16px; border-radius: 999px; border: none; background: #1d4ed8; color: #f9fafb; font-size: 0.9rem; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; box-shadow: 0 8px 16px rgba(37, 99, 235, 0.35); transition: all 0.15s ease-in-out; }
    .primary-btn:hover { background: #2563eb; transform: translateY(-1px); box-shadow: 0 10px 20px rgba(37, 99, 235, 0.42); }
    .primary-btn:active { transform: translateY(0); box-shadow: 0 6px 12px rgba(37, 99, 235, 0.25); }
    .missing-msg { font-size: 0.85rem; color: #b91c1c; background: #fef2f2; border-radius: 8px; border: 1px solid #fecaca; padding: 8px 10px; max-width: 640px; margin-top: 6px; display: none; }
    .results-panel { margin-top: 16px; background: #ffffff; border-radius: 10px; border: 1px solid #e5e7eb; padding: 12px 12px 14px; box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08); display: none; }
    .results-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-top: 4px; }
    .results-table th, .results-table td { border: 1px solid #e5e7eb; padding: 6px 8px; text-align: left; }
    .results-table th { background: #f3f4f6; }
    .global-result { margin-top: 8px; font-size: 0.9rem; padding: 8px 10px; border-radius: 8px; background: #eff6ff; border: 1px solid #bfdbfe; color: #1d4ed8; }
    .global-level-tag { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 0.8rem; font-weight: 600; margin-left: 6px; background: #1d4ed8; color: #eff6ff; }
    .id-box { margin-top: 10px; font-size: 0.9rem; padding: 8px 10px; border-radius: 8px; background: #ecfeff; border: 1px solid #22d3ee; color: #0f172a; display: none; }
    .id-box strong { font-weight: 600; }
    .sd-field { margin-bottom: 12px; padding: 4px 0; border-radius: 8px; }
    .sd-field.sd-missing strong { color: #b91c1c; }
    .sd-field.sd-missing .item-select { border-color: #f97373; background: #fef2f2; box-shadow: 0 0 0 1px rgba(248, 113, 113, 0.5); }
    .sd-field.sd-answered { background: #ecfdf3; border: 1px solid #22c55e; box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.3); }
    .sd-field.sd-answered strong { color: #166534; }
    .consent-wrapper { margin-top: 12px; font-size: 0.9rem; padding: 6px 8px; border-radius: 8px; transition: all 0.15s ease-in-out; }
    .consent-wrapper.consent-error { border: 1px solid #f97373; background: #fef2f2; box-shadow: 0 0 0 1px rgba(248, 113, 113, 0.5); }
    .consent-wrapper.consent-error label { color: #b91c1c; font-weight: 600; }
    @media (max-width: 900px) { .app-container { flex-direction: column; } .sidebar { width: 100%; } }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div>
        <h1>Escala de autoevaluaci√≥n del nivel de conocimiento en habilidades de investigaci√≥n cient√≠fica (EAN-IN)</h1>
        <small>Instrumento de autoevaluaci√≥n</small>
      </div>
      <div class="credits">
        <strong>Desarrollada por:</strong><br /><br />
        <strong>Dr. Kristian Armando Pineda Castillo</strong><br />
        Universidad Pedag√≥gica del Estado de Sinaloa<br />
        ORCID: <a href="https://orcid.org/0000-0002-4686-3587" target="_blank">0000-0002-4686-3587</a><br /><br />
        <strong>Dra. Virginia Mac√≠az Ay√≥n</strong><br />
        Universidad Pedag√≥gica del Estado de Sinaloa<br />
        ORCID: <a href="https://orcid.org/0009-0006-8915-9721" target="_blank">0009-0006-8915-9721</a><br /><br />
        <strong>Dra. Esmeralda S√°nchez Navarro</strong><br />
        Universidad Pedag√≥gica del Estado de Sinaloa<br />
        ORCID: <a href="https://orcid.org/0000-0002-8812-2189" target="_blank">0000-0002-8812-2189</a>
      </div>
      <div id="nav-container" style="display:none;">
        <div class="section-tabs-title">Dimensiones</div>
        <div class="section-tabs" id="section-tabs"></div>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <!-- 1) PANTALLA DE PRESENTACI√ìN (INTRO + CONSENTIMIENTO) -->
      <div id="presentation-screen">
        <div class="instructions" id="intro-block">
          <h2>Presentaci√≥n de la EAN-IN</h2>
          <p>
            La <strong>Escala de Autoevaluaci√≥n del Nivel de Conocimiento en Habilidades de Investigaci√≥n Cient√≠fica (EAN-IN)</strong>
            es un instrumento de autoevaluaci√≥n que tiene el fin de medir el nivel de conocimiento de habilidades sobre la
            investigaci√≥n cient√≠fica en estudiantes universitarios.
          </p>
          <p>
            Eval√∫a habilidades relacionadas con el planteamiento del problema, la revisi√≥n de la literatura, la metodolog√≠a,
            el m√©todo, los resultados, la discusi√≥n, las conclusiones y la comunicaci√≥n cient√≠fica.
          </p>
          <p><strong>¬øA qui√©n est√° dirigida la EAN-IN?</strong></p>
          <p>
            La EAN-IN est√° dirigida a <strong>estudiantes universitarios de pregrado y posgrado</strong> que participan en procesos
            de formaci√≥n en investigaci√≥n cient√≠fica.
          </p>
          <button id="go-consent-btn" class="primary-btn" style="margin-top: 10px;">
            Leer consentimiento informado
          </button>
        </div>

        <!-- Consentimiento informado -->
        <div id="consent-block" style="display:none; background:#ffffff; padding:16px; border-radius:12px; border:1px solid #e5e7eb; margin-top:12px;">
          <h2>Consentimiento informado</h2>
          <p>
            El siguiente instrumento de autoevaluaci√≥n es parte de una investigaci√≥n educativa registrada ante la
            <strong>Secretar√≠a de Ciencia, Humanidades, Tecnolog√≠a e Innovaci√≥n</strong> (Folio <strong>IH-2025-I-407</strong>)
            por parte de la <strong>Universidad Pedag√≥gica del Estado de Sinaloa</strong>.
          </p>
          <p>
            El objetivo del cuestionario es contribuir a diagnosticar el nivel de conocimiento preliminar de los estudiantes
            sobre dise√±os de investigaci√≥n educativa y redacci√≥n cient√≠fica. Su participaci√≥n en esta investigaci√≥n permitir√°
            contribuir al proceso de calidad en la formaci√≥n universitaria, as√≠ como a la toma de decisiones acad√©micas y cient√≠ficas.
          </p>
          <p>
            No se ha detectado ning√∫n riesgo que implique esta investigaci√≥n; sin embargo, si no se siente c√≥modo proporcionando
            alguna informaci√≥n, tiene la libertad de abandonar la investigaci√≥n antes de finalizar la contestaci√≥n del instrumento,
            sin que esto le afecte en lo absoluto.
          </p>
          <p>
            La contestaci√≥n de este instrumento de autoevaluaci√≥n es una actividad meramente <strong>voluntaria y an√≥nima</strong>,
            de modo que no se solicita su nombre. La informaci√≥n recolectada se utilizar√° para la mejora de la calidad educativa
            universitaria y el desarrollo del proyecto de investigaci√≥n, as√≠ como para la diseminaci√≥n de resultados en congresos,
            simposios, coloquios u otros medios de publicaci√≥n, divulgaci√≥n o difusi√≥n acad√©mica o cient√≠fica.
          </p>
          <p>
            Lo √∫nico que se le pide es contestar con honestidad de acuerdo con sus conocimientos. Si est√° de acuerdo en continuar,
            conteste las preguntas; de lo contrario, puede abandonar este proceso sin ninguna consecuencia acad√©mica o personal.
          </p>
          <p><strong>Datos del proyecto</strong></p>
          <p><strong>Investigador responsable:</strong> Dr. Kristian Armando Pineda Castillo</p>
          <p><strong>T√≠tulo del proyecto:</strong> Uso de material multimedia en formato de video para potenciar el aprendizaje
            cient√≠fico universitario: el aprendizaje de la investigaci√≥n educativa y la redacci√≥n cient√≠fica.</p>
          <p><strong>Folio:</strong> IH-2025-I-407</p>
          <p>
            <strong>Objetivo general del proyecto:</strong> Describir la forma en que el uso de material multimedia en formato
            de video impacta en el proceso de aprendizaje de la investigaci√≥n educativa y la redacci√≥n cient√≠fica en el contexto
            universitario de la Universidad Pedag√≥gica del Estado de Sinaloa.
          </p>
          <p><strong>Contacto:</strong> kristian.pineda@upes.edu.mx</p>

          <button id="download-consent-btn" class="primary-btn" type="button">
            Descargar consentimiento informado (PDF)
          </button>

          <div id="consent-wrapper" class="consent-wrapper">
            <label>
              <input type="checkbox" id="consent-checkbox" />
              He le√≠do y comprendido la informaci√≥n anterior. Acepto participar voluntariamente en este estudio, entendiendo
              que mi participaci√≥n es confidencial y puedo retirarme en cualquier momento sin consecuencias.
            </label>
          </div>

          <!-- Mensaje de error rojo -->
          <div id="consent-error-msg" class="missing-msg" style="display: none; margin-top: 12px;">
            Debes marcar la casilla de consentimiento informado para continuar.
          </div>

          <button id="accept-consent-btn" class="primary-btn" style="margin-top:10px;">
            Continuar a instrucciones
          </button>
        </div>
      </div>

      <!-- 2) PANTALLA DE INSTRUCCIONES -->
      <div id="instructions-screen" style="display:none;">
        <div class="instructions">
          <h2>Instrucciones</h2>
          <p>Este instrumento de autoevaluaci√≥n valora tu nivel de conocimiento del proceso de investigaci√≥n.</p>
          <p>No hay respuestas ‚Äòbuenas o malas‚Äô; responde con honestidad seg√∫n consideres tu nivel de conocimiento actual.</p>
          <p><strong>Opciones de respuesta:</strong></p>
          <ul class="options-list">
            <li>1 = No conozco del tema.</li>
            <li>2 = Conozco poco del tema.</li>
            <li>3 = Tengo conocimiento suficiente del tema.</li>
            <li>4 = Manejo el tema con seguridad.</li>
            <li>5 = Domino el tema ampliamente.</li>
          </ul>
          <button id="presentation-start-btn" class="primary-btn" style="margin-top: 10px;">
            Ir a datos generales
          </button>
        </div>
      </div>

      <!-- 3) BLOQUE SOCIODEMOGR√ÅFICO -->
      <div id="sociodemo-screen" style="background: white; padding: 20px; border-radius: 12px; border: 1px solid #e5e7eb; margin-bottom: 20px;">
        <h2>Datos generales</h2>
        <p>Los siguientes datos se solicitan √∫nicamente para realizar an√°lisis comparativos entre grupos. Tu informaci√≥n es completamente confidencial.</p>
        <div class="sd-field" id="sd-field-sex">
          <label><strong>Sexo:</strong></label>
          <select id="sd-sex" class="item-select">
            <option value="">Seleccione‚Ä¶</option>
            <option value="Masculino">Masculino</option>
            <option value="Femenino">Femenino</option>
            <option value="No binario">No binario</option>
            <option value="Prefiero no decirlo">Prefiero no decirlo</option>
          </select>
        </div>
        <div class="sd-field" id="sd-field-age">
          <label><strong>Edad:</strong></label>
          <select id="sd-age" class="item-select">
            <option value="">Seleccione‚Ä¶</option>
          </select>
        </div>
        <div class="sd-field" id="sd-field-level">
          <label><strong>Nivel educativo en curso:</strong></label>
          <select id="sd-level" class="item-select">
            <option value="">Seleccione‚Ä¶</option>
            <option value="Licenciatura">Estudiante de Licenciatura</option>
            <option value="Maestr√≠a">Estudiante de Maestr√≠a</option>
            <option value="Doctorado">Estudiante de Doctorado</option>
            <option value="Posdoctorado">En estancia posdoctoral</option>
          </select>
        </div>
        <div class="sd-field" id="sd-field-semester">
          <label><strong>Semestre:</strong></label>
          <select id="sd-semester" class="item-select">
            <option value="">Seleccione‚Ä¶</option>
            <option value="1">Primer semestre</option>
            <option value="2">Segundo semestre</option>
            <option value="3">Tercer semestre</option>
            <option value="4">Cuarto semestre</option>
            <option value="5">Quinto semestre</option>
            <option value="6">Sexto semestre</option>
            <option value="7">S√©ptimo semestre</option>
            <option value="8">Octavo semestre</option>
            <option value="9">Noveno semestre</option>
            <option value="10">D√©cimo semestre</option>
          </select>
        </div>
        <button id="start-survey-btn" style="padding: 10px 16px; background: #1d4ed8; color: white; border-radius: 8px; cursor: pointer; border: none;">
          Iniciar cuestionario
        </button>
      </div>

      <h2 class="section-title-main" id="current-section-title"></h2>
      <div id="items-container" class="items-grid"></div>

      <!-- Barra de navegaci√≥n principal (durante el cuestionario) -->
      <div class="actions">
        <button id="next-section-btn" class="primary-btn">Siguiente secci√≥n</button>
        <button id="results-btn" class="primary-btn" style="display:none;">Ver resultados</button>
        <div id="missing-msg" class="missing-msg"></div>
      </div>

      <!-- NUEVA PANTALLA FINAL -->
      <div id="final-screen" style="display:none; margin-top:20px;">
        <div class="instructions" style="background:#ecfdf3; border:1px solid #22c55e; border-radius:10px; padding:12px 14px; margin-bottom:10px;">
          <h2 style="margin-top:0;">
            Has finalizado la contestaci√≥n de la Escala de autoevaluaci√≥n del nivel de conocimiento en habilidades de investigaci√≥n cient√≠fica (EAN-IN)
          </h2>
          <p>
            Muchas gracias por tu participaci√≥n. A continuaci√≥n se muestran tus resultados y tendr√°s la opci√≥n de descargarlos en PDF.
          </p>
        </div>

        <div id="id-box" class="id-box">
          Tu ID de participante es: <strong id="respondent-id"></strong>. Te sugerimos guardarlo para los fines acad√©micos o personales que consideres pertinentes.
        </div>

        <div class="results-panel">
          <h3>Resultados por dimensi√≥n</h3>
          <table class="results-table" id="results-table">
            <thead>
              <tr>
                <th>Secci√≥n</th>
                <th>Promedio</th>
                <th>Nivel</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div id="global-result" class="global-result">
            Responde todos los √≠tems y pulsa <strong>‚ÄúVer resultados‚Äù</strong> para ver tu resultado global.
          </div>
        </div>

        <div class="actions" style="display:flex; margin-top:10px;">
          <button id="pdf-btn" class="primary-btn" style="display:none;">Descargar PDF</button>
          <button id="go-home-btn" class="primary-btn" type="button">Volver a la p√°gina principal</button>
        </div>
      </div>
    </main>
  </div>

  <script>
    /* =====================================
       0. CONFIGURACI√ìN B√ÅSICA
       ===================================== */
    const ENDPOINT_URL = "https://script.google.com/macros/s/AKfycbyrd2Wbf8zTeokuGOanyQbo2zNWpxqdqLislnSMoGX10UNG56fGmDBQmnPKdHBoXniA/exec";
    const respondentId = "EAN-" + Date.now().toString(36).toUpperCase();
    const savedResponses = {};
    const sociodemo = { sex: "", age: "", level: "", semester: "" };
    let currentSectionIndex = 0;
    let currentView = "presentation";
    let lastResults = null;
    let consentAccepted = false;
    let resultsSent = false; // para evitar env√≠os duplicados
    let surveyLocked = false; // NUEVO: para bloquear navegaci√≥n tras finalizar

    function range(start, end) {
      const arr = [];
      for (let i = start; i <= end; i++) arr.push(i);
      return arr;
    }

    const sections = [
      { id: "planteamiento", name: "Planteamiento del problema", items: range(1, 8) },
      { id: "revision", name: "Revisi√≥n de la literatura", items: range(9, 15) },
      { id: "metodologia", name: "Metodolog√≠a", items: range(16, 36) },
      { id: "metodo", name: "M√©todo", items: range(37, 50) },
      { id: "resultados", name: "Resultados", items: range(51, 59) },
      { id: "discusion", name: "Discusi√≥n", items: range(60, 65) },
      { id: "conclusiones", name: "Conclusiones", items: range(66, 70) },
      { id: "comunicacion", name: "Comunicaci√≥n cient√≠fica", items: range(71, 80) }
    ];

    const itemText = {
      1: "S√© identificar un problema de investigaci√≥n.",
      2: "Conozco c√≥mo contextualizar un objeto de estudio con apoyo de antecedentes te√≥ricos y/o estad√≠sticos.",
      3: "S√© establecer la delimitaci√≥n temporal, geogr√°fica, conceptual y disciplinar de un objeto de estudio.",
      4: "Conozco c√≥mo justificar la importancia de un objeto de estudio.",
      5: "S√© fundamentar la viabilidad de un estudio.",
      6: "S√© plantear preguntas de investigaci√≥n.",
      7: "S√© desarrollar objetivos de investigaci√≥n.",
      8: "Conozco c√≥mo definir hip√≥tesis o supuestos de investigaci√≥n.",
      9: "S√© realizar una revisi√≥n de la literatura en fuentes confiables.",
      10: "Conozco c√≥mo desarrollar un marco te√≥rico.",
      11: "S√© realizar una discusi√≥n epistemol√≥gica.",
      12: "S√© elaborar la evoluci√≥n hist√≥rica de un objeto de estudio.",
      13: "S√© desarrollar el estado del arte explorando estudios a nivel local, nacional e internacional.",
      14: "Conozco c√≥mo identificar vac√≠os del conocimiento de un objeto de estudio.",
      15: "S√© identificar vac√≠os metodol√≥gicos de un objeto de estudio.",
      16: "S√© fundamentar el enfoque metodol√≥gico seg√∫n los objetivos y preguntas de investigaci√≥n.",
      17: "Conozco c√≥mo determinar el alcance de la investigaci√≥n.",
      18: "Conozco c√≥mo definir los l√≠mites metodol√≥gicos de la investigaci√≥n.",
      19: "S√© describir el m√©todo o dise√±o a desarrollar en un estudio.",
      20: "S√© definir la muestra o participantes.",
      21: "S√© justificar el m√©todo de muestreo o selecci√≥n de participantes.",
      22: "S√© definir los criterios de inclusi√≥n de la muestra o participantes.",
      23: "Conozco c√≥mo describir el escenario de investigaci√≥n.",
      24: "Conozco las diferentes t√©cnicas de investigaci√≥n cualitativa.",
      25: "Conozco las diferentes t√©cnicas de investigaci√≥n cuantitativa.",
      26: "S√© elegir instrumentos existentes para una investigaci√≥n.",
      27: "Conozco c√≥mo adaptar un instrumento de investigaci√≥n.",
      28: "S√© desarrollar instrumentos de recolecci√≥n de datos.",
      29: "Conozco procedimientos psicom√©tricos para validar instrumentos.",
      30: "S√© detallar el procedimiento (tiempos, recursos, recolecci√≥n de datos).",
      31: "S√© detallar los pasos para el an√°lisis de los datos.",
      32: "Conozco distintas formas de analizar datos cualitativos y/o cuantitativos.",
      33: "S√© reportar el uso de software que se podr√≠a utilizar para el an√°lisis de datos.",
      34: "Conozco c√≥mo aplicar la √©tica investigativa.",
      35: "Conozco los aspectos √©ticos de un consentimiento informado.",
      36: "S√© asegurar rigor a una investigaci√≥n con estrategias de validez.",
      37: "Conozco el dise√±o de investigaci√≥n-acci√≥n y sus variantes.",
      38: "Conozco el dise√±o de teor√≠a fundamentada y sus variantes.",
      39: "Conozco el dise√±o de etnograf√≠a y sus variantes.",
      40: "Conozco el dise√±o de fenomenolog√≠a y sus variantes.",
      41: "Conozco el dise√±o de estudio de caso y sus variantes.",
      42: "Conozco el dise√±o narrativo.",
      43: "Conozco el dise√±o de investigaci√≥n documental.",
      44: "Conozco el dise√±o de revisi√≥n sistem√°tica.",
      45: "Conozco el dise√±o de metaan√°lisis.",
      46: "Conozco el dise√±o experimental.",
      47: "Conozco el dise√±o no experimental (encuesta, correlacional y descriptivo).",
      48: "Conozco el dise√±o cuasiexperimental.",
      49: "Conozco el dise√±o preexperimental.",
      50: "Conozco el dise√±o factorial.",
      51: "Conozco c√≥mo reflejar un enfoque metodol√≥gico aplicado.",
      52: "S√© reflejar en los resultados un m√©todo o dise√±o empleado.",
      53: "Conozco c√≥mo presentar evidencia de t√©cnicas e instrumentos aplicados.",
      54: "S√© presentar evidencia de validaci√≥n de instrumentos.",
      55: "Conozco c√≥mo interpretar datos de instrumentos aplicados.",
      56: "S√© reflejar el logro de objetivos.",
      57: "S√© presentar evidencia de los datos recolectados.",
      58: "S√© utilizar apoyos visuales (como tablas, gr√°ficas, im√°genes o diagramas) para presentar resultados.",
      59: "Conozco c√≥mo documentar evidencia de software utilizado.",
      60: "S√© contrastar hallazgos emp√≠ricos con los de otros estudios.",
      61: "Conozco c√≥mo dar cuenta de las limitaciones de una investigaci√≥n.",
      62: "S√© contrastar los resultados a la luz de la teor√≠a.",
      63: "Conozco c√≥mo presentar posibles sesgos de un estudio.",
      64: "S√© presentar implicaciones de resultados.",
      65: "Conozco c√≥mo sugerir futuras l√≠neas de investigaci√≥n.",
      66: "S√© presentar conclusiones del estudio.",
      67: "Conozco c√≥mo reflexionar sobre los resultados alcanzados.",
      68: "Conozco c√≥mo retomar el alcance de objetivos.",
      69: "S√© sintetizar el estudio.",
      70: "Conozco c√≥mo realizar recomendaciones generales.",
      71: "S√© redactar un reporte de investigaci√≥n en alg√∫n formato: tesis, art√≠culo, cap√≠tulo de libro, entre otros.",
      72: "Conozco oportunidades para la difusi√≥n de resultados de investigaci√≥n en espacios acad√©micos (simposios, congresos, coloquios, entre otros).",
      73: "Conozco c√≥mo elaborar materiales de apoyo (presentaciones digitales, p√≥steres, res√∫menes gr√°ficos, infograf√≠as).",
      74: "S√© aplicar criterios de claridad y coherencia en la comunicaci√≥n cient√≠fica.",
      75: "Conozco oportunidades para la divulgaci√≥n cient√≠fica (revistas y medios de divulgaci√≥n, repositorios y plataformas para p√∫blico general).",
      76: "S√© dar cr√©dito a autores por sus ideas.",
      77: "Conozco c√≥mo citar obras de autores y diferentes fuentes documentales.",
      78: "S√© gestionar citas de acuerdo con un estilo (APA, Chicago, Vancouver).",
      79: "S√© elaborar la referencia de obras de autores y diferentes fuentes documentales.",
      80: "S√© gestionar referencias seg√∫n el estilo solicitado (APA, Chicago, Vancouver, entre otros)."
    };

    const itemToSection = {};
    sections.forEach(sec => sec.items.forEach(i => { itemToSection[i] = sec; }));

    const tabsContainer = document.getElementById("section-tabs");
    const navContainer = document.getElementById("nav-container");
    const itemsContainer = document.getElementById("items-container");
    const currentSectionTitle = document.getElementById("current-section-title");
    const missingMsg = document.getElementById("missing-msg");
    const nextBtn = document.getElementById("next-section-btn");
    const resultsBtn = document.getElementById("results-btn");
    const pdfBtn = document.getElementById("pdf-btn");
    const idBox = document.getElementById("id-box");
    const respondentIdSpan = document.getElementById("respondent-id");
    const resultsPanel = document.querySelector(".results-panel");
    const actionsBar = document.querySelector(".actions"); // la primera barra de acciones
    const finalScreen = document.getElementById("final-screen");
    const goHomeBtn = document.getElementById("go-home-btn");

    const presentationScreen = document.getElementById("presentation-screen");
    const instructionsScreen = document.getElementById("instructions-screen");
    const sociodemoScreen = document.getElementById("sociodemo-screen");
    const introBlock = document.getElementById("intro-block");
    const consentBlock = document.getElementById("consent-block");
    const goConsentBtn = document.getElementById("go-consent-btn");
    const downloadConsentBtn = document.getElementById("download-consent-btn");
    const consentCheckbox = document.getElementById("consent-checkbox");
    const acceptConsentBtn = document.getElementById("accept-consent-btn");
    const consentWrapper = document.getElementById("consent-wrapper");
    const consentErrorMsg = document.getElementById("consent-error-msg");

    // Tabs
    const presentationTabBtn = document.createElement("button");
    presentationTabBtn.className = "tab-button active";
    presentationTabBtn.id = "tab-presentation";
    presentationTabBtn.innerHTML = `<span>Presentaci√≥n</span><span class="tab-badge" id="badge-presentation">Info</span>`;
    presentationTabBtn.addEventListener("click", onPresentationTabClick);
    tabsContainer.appendChild(presentationTabBtn);

    const instructionsTabBtn = document.createElement("button");
    instructionsTabBtn.className = "tab-button";
    instructionsTabBtn.id = "tab-instructions";
    instructionsTabBtn.innerHTML = `<span>Instrucciones</span><span class="tab-badge" id="badge-instructions">Gu√≠a</span>`;
    instructionsTabBtn.addEventListener("click", onInstructionsTabClick);
    tabsContainer.appendChild(instructionsTabBtn);

    const socioTabBtn = document.createElement("button");
    socioTabBtn.className = "tab-button";
    socioTabBtn.id = "tab-socio";
    socioTabBtn.innerHTML = `<span>Datos generales</span><span class="tab-badge" id="badge-socio">DG</span>`;
    socioTabBtn.addEventListener("click", onSociodemoTabClick);
    tabsContainer.appendChild(socioTabBtn);

    sections.forEach((sec, idx) => {
      const btn = document.createElement("button");
      btn.className = "tab-button";
      btn.dataset.index = idx;
      btn.innerHTML = `<span>${sec.name}</span><span class="tab-badge" id="badge-${sec.id}">${sec.items[0]}‚Äì${sec.items[sec.items.length - 1]}</span>`;
      btn.addEventListener("click", () => onTabClick(idx));
      tabsContainer.appendChild(btn);
    });

    // Edades
    const ageSelect = document.getElementById("sd-age");
    for (let i = 18; i <= 100; i++) {
      const opt = document.createElement("option");
      opt.value = i;
      opt.textContent = i + " a√±os";
      ageSelect.appendChild(opt);
    }

    // Marcar campos sociodemogr√°ficos como respondidos
    ["sex", "age", "level", "semester"].forEach(name => {
      const sel = document.getElementById("sd-" + name);
      const fieldDiv = document.getElementById("sd-field-" + name);
      if (!sel || !fieldDiv) return;
      sel.addEventListener("change", () => {
        if (sel.value) {
          fieldDiv.classList.remove("sd-missing");
          fieldDiv.classList.add("sd-answered");
        } else {
          fieldDiv.classList.remove("sd-answered");
        }
      });
    });

    /* =====================================
       2a. L√ìGICA DE PRESENTACI√ìN / CONSENTIMIENTO
       ===================================== */
    if (goConsentBtn) {
      goConsentBtn.addEventListener("click", () => {
        introBlock.style.display = "none";
        consentBlock.style.display = "block";
      });
    }

    if (consentCheckbox && acceptConsentBtn) {
      consentCheckbox.addEventListener("change", () => {
        if (consentCheckbox.checked) {
          consentWrapper.classList.remove("consent-error");
          if (consentErrorMsg) consentErrorMsg.style.display = "none";
        }
      });

      acceptConsentBtn.addEventListener("click", () => {
        if (!consentCheckbox.checked) {
          consentWrapper.classList.add("consent-error");
          if (consentErrorMsg) consentErrorMsg.style.display = "block";
          return;
        }

        consentWrapper.classList.remove("consent-error");
        if (consentErrorMsg) consentErrorMsg.style.display = "none";

        consentAccepted = true;
        presentationScreen.style.display = "none";
        instructionsScreen.style.display = "block";
        currentView = "instructions";

        document.querySelectorAll(".tab-button").forEach(b => b.classList.remove("active"));
        instructionsTabBtn.classList.add("active");
      });
    }

    function onPresentationTabClick() {
      if (surveyLocked) return; // NUEVO: ya no se puede navegar
      document.querySelectorAll(".tab-button").forEach(b => b.classList.remove("active"));
      presentationTabBtn.classList.add("active");
      currentView = "presentation";
      presentationScreen.style.display = "block";
      instructionsScreen.style.display = "none";
      sociodemoScreen.style.display = "none";
      currentSectionTitle.style.display = "none";
      itemsContainer.style.display = "none";
      actionsBar.style.display = "none";
      resultsPanel.style.display = lastResults ? "block" : "none";
      missingMsg.style.display = "none";
      missingMsg.textContent = "";
    }

    function onInstructionsTabClick() {
      if (surveyLocked) return; // NUEVO
      if (!consentAccepted) {
        consentWrapper.classList.add("consent-error");
        if (consentErrorMsg) consentErrorMsg.style.display = "block";
        alert("Primero debes aceptar el consentimiento informado en la pesta√±a 'Presentaci√≥n'.");
        onPresentationTabClick();
        return;
      }
      document.querySelectorAll(".tab-button").forEach(b => b.classList.remove("active"));
      instructionsTabBtn.classList.add("active");
      currentView = "instructions";
      presentationScreen.style.display = "none";
      instructionsScreen.style.display = "block";
      sociodemoScreen.style.display = "none";
      currentSectionTitle.style.display = "none";
      itemsContainer.style.display = "none";
      actionsBar.style.display = "none";
      resultsPanel.style.display = lastResults ? "block" : "none";
      missingMsg.style.display = "none";
      missingMsg.textContent = "";
    }

    function onSociodemoTabClick() {
      if (surveyLocked) return; // NUEVO
      document.querySelectorAll(".tab-button").forEach(b => b.classList.remove("active"));
      socioTabBtn.classList.add("active");
      currentView = "socio";
      presentationScreen.style.display = "none";
      instructionsScreen.style.display = "none";
      sociodemoScreen.style.display = "block";
      currentSectionTitle.style.display = "none";
      itemsContainer.style.display = "none";
      actionsBar.style.display = "none";
      resultsPanel.style.display = lastResults ? "block" : "none";
      missingMsg.style.display = "none";
      missingMsg.textContent = "";
    }

    document.getElementById("presentation-start-btn").addEventListener("click", () => {
      navContainer.style.display = "block";
      onSociodemoTabClick();
    });

    document.getElementById("start-survey-btn").addEventListener("click", () => {
      const sex = document.getElementById("sd-sex").value;
      const age = document.getElementById("sd-age").value;
      const level = document.getElementById("sd-level").value;
      const semester = document.getElementById("sd-semester").value;

      ["sex", "age", "level", "semester"].forEach(f => {
        const fieldDiv = document.getElementById("sd-field-" + f);
        if (fieldDiv) fieldDiv.classList.remove("sd-missing");
      });

      if (!sex) document.getElementById("sd-field-sex").classList.add("sd-missing");
      if (!age) document.getElementById("sd-field-age").classList.add("sd-missing");
      if (!level) document.getElementById("sd-field-level").classList.add("sd-missing");
      if (!semester) document.getElementById("sd-field-semester").classList.add("sd-missing");

      if (!sex || !age || !level || !semester) {
        alert("Por favor completa todos los datos antes de continuar.");
        return;
      }

      sociodemo.sex = sex;
      sociodemo.age = age;
      sociodemo.level = level;
      sociodemo.semester = semester;

      const badgeSocio = document.getElementById("badge-socio");
      socioTabBtn.classList.add("completed");
      if (badgeSocio) badgeSocio.textContent = "Completado";

      // üîπ OCULTAR PESTA√ëAS DE INTRODUCCI√ìN AL INICIAR LA ESCALA
  presentationTabBtn.style.display  = "none";
  instructionsTabBtn.style.display  = "none";
  socioTabBtn.style.display         = "none";

  navContainer.style.display = "block";
  renderSection(0);
});

    /* =====================================
       3. RENDER DE SECCI√ìN
       ===================================== */
    function renderSection(index) {
      const sec = sections[index];
      currentSectionIndex = index;
      currentView = "section";
      presentationScreen.style.display = "none";
      instructionsScreen.style.display = "none";
      sociodemoScreen.style.display = "none";
      currentSectionTitle.style.display = "block";
      itemsContainer.style.display = "grid";
      actionsBar.style.display = "flex";
      resultsPanel.style.display = "block";
      currentSectionTitle.textContent = sec.name;

      document.querySelectorAll(".tab-button").forEach(btn => btn.classList.remove("active"));
      const currentBtn = document.querySelector(`.tab-button[data-index="${index}"]`);
      if (currentBtn) currentBtn.classList.add("active");

      itemsContainer.innerHTML = "";
      sec.items.forEach(itemNum => {
        const card = document.createElement("div");
        card.className = "item-card";
        card.id = `card-item-${itemNum}`;
        const label = document.createElement("div");
        label.className = "item-label";
        label.innerHTML = `<span>${itemNum}.</span> ${itemText[itemNum] || ""}`;
        const select = document.createElement("select");
        select.className = "item-select";
        select.id = `item-${itemNum}`;
        select.innerHTML = `
          <option value="">Seleccione una respuesta...</option>
          <option value="1">1 = No conozco del tema.</option>
          <option value="2">2 = Conozco poco del tema.</option>
          <option value="3">3 = Tengo conocimiento suficiente del tema.</option>
          <option value="4">4 = Manejo el tema con seguridad.</option>
          <option value="5">5 = Domino el tema ampliamente.</option>
        `;
        if (savedResponses[itemNum]) {
          select.value = savedResponses[itemNum];
          card.classList.add("answered");
        }
        select.addEventListener("change", () => {
          savedResponses[itemNum] = select.value;
          if (select.value !== "") {
            card.classList.add("answered");
            card.classList.remove("missing");
          } else {
            card.classList.remove("answered");
          }
          updateSectionCompletionStatus(sec);
        });
        card.appendChild(label);
        card.appendChild(select);
        itemsContainer.appendChild(card);
      });
      updateNavigationButtons();
      missingMsg.style.display = "none";
      missingMsg.textContent = "";
    }

    function updateNavigationButtons() {
      if (currentSectionIndex < sections.length - 1) {
        nextBtn.style.display = "inline-flex";
        resultsBtn.style.display = "none";
      } else {
        nextBtn.style.display = "none";
        resultsBtn.style.display = "inline-flex";
      }
    }

    /* =====================================
       4. COMPLECI√ìN / NAVEGACI√ìN
       ===================================== */
    function isSectionComplete(sec) {
      return sec.items.every(i => savedResponses[i] && savedResponses[i] !== "");
    }

    function updateSectionCompletionStatus(sec) {
      const badge = document.getElementById(`badge-${sec.id}`);
      const tabBtn = Array.from(document.querySelectorAll(".tab-button")).find(
        b => Number(b.dataset.index) === sections.indexOf(sec)
      );
      if (isSectionComplete(sec)) {
        if (tabBtn) tabBtn.classList.add("completed");
        if (badge) badge.textContent = "Completada";
      } else {
        if (tabBtn) tabBtn.classList.remove("completed");
        if (badge) badge.textContent = `${sec.items[0]}‚Äì${sec.items[sec.items.length - 1]}`;
      }
    }

    function highlightMissingItems(missingItems) {
      const currentSec = sections[currentSectionIndex];
      currentSec.items.forEach(i => {
        const card = document.getElementById(`card-item-${i}`);
        if (card) card.classList.remove("missing");
      });
      missingItems.forEach(i => {
        const card = document.getElementById(`card-item-${i}`);
        if (card) card.classList.add("missing");
      });
      if (missingItems.length > 0) {
        const firstCard = document.getElementById(`card-item-${missingItems[0]}`);
        if (firstCard) firstCard.scrollIntoView({ behavior: "smooth", block: "center" });
      }
    }

    function onTabClick(targetIndex) {
      if (surveyLocked) return; // NUEVO
      if (!sociodemo.sex || !sociodemo.age || !sociodemo.level || !sociodemo.semester) {
        alert("Primero completa la secci√≥n 'Datos generales' y pulsa 'Iniciar cuestionario'.");
        onSociodemoTabClick();
        return;
      }
      if (currentView === "section" && targetIndex > currentSectionIndex && !isSectionComplete(sections[currentSectionIndex])) {
        const missing = sections[currentSectionIndex].items.filter(i => !savedResponses[i] || savedResponses[i] === "");
        highlightMissingItems(missing);
        missingMsg.style.display = "block";
        missingMsg.innerHTML = `<strong>No puedes avanzar porque faltan respuestas en esta secci√≥n.</strong><br><br><strong>√çtems faltantes:</strong> ${missing.join(", ")}`;
        alert("No puedes avanzar porque faltan respuestas en esta secci√≥n.\n\n√çtems faltantes: " + missing.join(", "));
        return;
      }
      missingMsg.style.display = "none";
      missingMsg.textContent = "";
      renderSection(targetIndex);
    }

    nextBtn.addEventListener("click", () => {
      const currentSec = sections[currentSectionIndex];
      const missing = currentSec.items.filter(i => !savedResponses[i] || savedResponses[i] === "");
      if (missing.length > 0) {
        highlightMissingItems(missing);
        missingMsg.style.display = "block";
        missingMsg.innerHTML = `<strong>Faltan por responder los siguientes √≠tems de esta secci√≥n:</strong><br>${missing.join(", ")}`;
        alert("Por favor, responde todas las preguntas de la secci√≥n actual antes de avanzar.\n\n√çtems faltantes: " + missing.join(", "));
        return;
      }
      missingMsg.style.display = "none";
      missingMsg.textContent = "";
      if (currentSectionIndex < sections.length - 1) renderSection(currentSectionIndex + 1);
    });

    /* =====================================
       5. NIVELES Y ENV√çO A SHEETS
       ===================================== */
    function levelFromAverage(avg) {
      if (avg <= 1.00) return "Sin conocimientos b√°sicos";
      if (avg > 1.00 && avg < 2.00) return "B√°sico";
      if (avg >= 2.00 && avg < 3.00) return "Intermedio";
      if (avg >= 3.00 && avg < 4.00) return "Bueno";
      return "Avanzado";
    }

    // NUEVO: mensaje interpretativo seg√∫n el promedio global
    function getGlobalDescription(avg) {
      if (avg <= 1.00) {
        return "El que usted se ubique en este nivel sugiere, de acuerdo con las respuestas que usted mismo dio, que no tiene conocimientos b√°sicos de los temas de habilidades de investigaci√≥n cient√≠fica y reconoce que requiere apoyo significativo para desarrollarlos a detalle.";
      } else if (avg > 1.00 && avg < 2.00) {
        return "El que usted se ubique en este nivel sugiere, de acuerdo con las respuestas que usted mismo dio, que tiene conocimientos muy b√°sicos de los temas de habilidades de investigaci√≥n cient√≠fica y reconoce que requiere apoyo significativo para desarrollarlos.";
      } else if (avg >= 2.00 && avg < 3.00) {
        return "El que usted se ubique en este nivel sugiere, de acuerdo con las respuestas que usted mismo dio, que conoce de los temas de habilidades de investigaci√≥n cient√≠fica y puede desarrollarlos adecuadamente, aunque reconoce limitaciones en puntos espec√≠ficos.";
      } else if (avg >= 3.00 && avg < 4.00) {
        return "El que usted se ubique en este nivel sugiere, de acuerdo con las respuestas que usted mismo dio, que maneja los temas de habilidades de investigaci√≥n cient√≠fica con claridad y seguridad; puede desarrollarlos con solvencia, salvo aspectos muy puntuales.";
      } else { // avg >= 4.00
        return "El que usted se ubique en este nivel sugiere, de acuerdo con las respuestas que usted mismo dio, que domina ampliamente los temas de habilidades de investigaci√≥n cient√≠fica y puede desarrollarlos con profundidad, detalle y precisi√≥n.";
      }
    }

    async function sendResponsesToSheet() {
      const payload = {
        responses: savedResponses,
        meta: {
          userAgent: navigator.userAgent,
          respondentId: respondentId,
          sex: sociodemo.sex,
          age: sociodemo.age,
          level: sociodemo.level,
          semester: sociodemo.semester
        }
      };
      try {
        await fetch(ENDPOINT_URL, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify(payload)
        });
      } catch (error) {
        console.error("Error en fetch:", error);
        alert("No fue posible enviar tus respuestas al servidor. Aunque puedes ver tus resultados, te sugerimos intentarlo de nuevo m√°s tarde.");
      }
    }

    /* =====================================
       6. C√ÅLCULO DE RESULTADOS
       ===================================== */
    resultsBtn.addEventListener("click", async () => {
  // Si ya se enviaron los resultados, no hacer nada m√°s
  if (resultsSent) {
    return;
  }

  // Deshabilitar bot√≥n inmediatamente para evitar clics m√∫ltiples
  resultsBtn.disabled = true;
  resultsBtn.textContent = "Procesando...";

  // Crear y mostrar mensaje temporal en verde
  const loadingMsg = document.createElement("div");
  loadingMsg.style.cssText = "font-size: 0.95rem; color: #166534; background: #ecfdf3; border: 1px solid #22c55e; border-radius: 8px; padding: 10px; margin-bottom: 12px; text-align: center;";
  loadingMsg.textContent = "Est√°s siendo dirigido a tus resultados...";
  resultsPanel.parentNode.insertBefore(loadingMsg, resultsPanel);

  const missing = [];
  for (let i = 1; i <= 80; i++) {
    if (!savedResponses[i] || savedResponses[i] === "") missing.push(i);
  }
  if (missing.length > 0) {
    const missingBySection = {};
    missing.forEach(i => {
      const sec = itemToSection[i];
      if (!missingBySection[sec.name]) missingBySection[sec.name] = [];
      missingBySection[sec.name].push(i);
    });
    let msg = "<strong>Faltan por responder los siguientes √≠tems:</strong><br />";
    Object.keys(missingBySection).forEach(secName => {
      msg += `<strong>${secName}:</strong> ${missingBySection[secName].join(", ")}<br />`;
    });
    const currentSec = sections[currentSectionIndex];
    const missingHere = missing.filter(i => currentSec.items.includes(i));
    highlightMissingItems(missingHere);
    missingMsg.innerHTML = msg;
    missingMsg.style.display = "block";

    // Restaurar bot√≥n si hay error
    resultsBtn.disabled = false;
    resultsBtn.textContent = "Ver resultados";
    loadingMsg.remove(); // Quitar mensaje
    return;
  } else {
    missingMsg.style.display = "none";
    missingMsg.textContent = "";
  }

  const tbody = document.querySelector("#results-table tbody");
  tbody.innerHTML = "";
  let allValues = [];
  const sectionResults = [];
  sections.forEach(sec => {
    const vals = sec.items.map(i => Number(savedResponses[i]));
    const avg = vals.reduce((a, b) => a + b, 0) / vals.length;
    const level = levelFromAverage(avg);
    allValues = allValues.concat(vals);
    sectionResults.push({ name: sec.name, avg, level });
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${sec.name}</td><td>${avg.toFixed(2)}</td><td>${level}</td>`;
    tbody.appendChild(tr);
  });

  const globalAvg = allValues.reduce((a, b) => a + b, 0) / allValues.length;
  const globalLevel = levelFromAverage(globalAvg);

  const globalDiv = document.getElementById("global-result");
  const description = getGlobalDescription(globalAvg);
  globalDiv.innerHTML = `
    <strong>Promedio global:</strong> ${globalAvg.toFixed(2)}
    <span class="global-level-tag">${globalLevel}</span>
    <br /><br />
    <strong>Interpretaci√≥n:</strong> ${description}
  `;

  lastResults = {
    respondentId,
    timestamp: new Date().toLocaleString("es-MX", { timeZone: "America/Mazatlan" }),
    sections: sectionResults,
    globalAvg,
    globalLevel,
    sociodemo: { ...sociodemo }
  };

  // Enviar a Google Sheets SOLO una vez
  await sendResponsesToSheet();

  respondentIdSpan.textContent = respondentId;
  idBox.style.display = "block";
  pdfBtn.style.display = "inline-flex";

  alert(
    "Tus respuestas se han enviado.\n\n" +
    "Tu ID de participante es: " + respondentId +
    ". Te sugerimos guardarlo para fines acad√©micos o personales."
  );

  // Marcar como enviado y ocultar el bot√≥n para evitar clics extra
  resultsSent = true;
  resultsBtn.style.display = "none";

  // NUEVO: bloquear navegaci√≥n y mostrar solo la pantalla final
  surveyLocked = true;
  if (navContainer) navContainer.style.display = "none";
  presentationScreen.style.display = "none";
  instructionsScreen.style.display = "none";
  sociodemoScreen.style.display = "none";
  currentSectionTitle.style.display = "none";
  itemsContainer.style.display = "none";
  actionsBar.style.display = "none";
  resultsPanel.style.display = "block";
  finalScreen.style.display = "block";

  // Quitar mensaje de carga y restaurar bot√≥n (aunque ya est√° oculto)
  loadingMsg.remove();
  resultsBtn.disabled = false;
  resultsBtn.textContent = "Ver resultados"; // Por si acaso
});

    /* =====================================
       7. PDF DE RESULTADOS
       ===================================== */
    function generatePDF() {
  if (!lastResults) {
    alert("Primero responde el cuestionario y consulta tus resultados.");
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({
    orientation: "portrait",
    unit: "mm",
    format: "a4"
  });

  // Configuraci√≥n optimizada para una sola hoja
  const marginLeft   = 18;
  const marginRight  = 18;
  const marginTop    = 20;
  const marginBottom = 20;
  const pageWidth    = doc.internal.pageSize.getWidth();
  const pageHeight   = doc.internal.pageSize.getHeight();
  const contentWidth = pageWidth - marginLeft - marginRight;

  let y = marginTop;

  // === ENCABEZADO ===
  doc.setFont("helvetica", "bold");
  doc.setFontSize(14); // m√°s peque√±o
  doc.setTextColor(0, 51, 102);
  const title = "Escala de Autoevaluaci√≥n del Nivel de Conocimiento en Habilidades de Investigaci√≥n Cient√≠fica (EAN-IN)";
  const titleLines = doc.splitTextToSize(title, contentWidth);
  doc.text(titleLines, pageWidth / 2, y, { align: "center" });
  y += titleLines.length * 7 + 5;

  doc.setLineWidth(0.7);
  doc.setDrawColor(0, 51, 102);
  doc.line(marginLeft, y, pageWidth - marginRight, y);
  y += 8;

  // === DATOS DEL PARTICIPANTE ===
  doc.setFont("helvetica", "bold");
  doc.setFontSize(11);
  doc.text("Datos del participante", marginLeft, y);
  y += 7;

  doc.setFont("helvetica", "normal");
  doc.setFontSize(10);
  const datos = [
    `ID de participante: ${lastResults.respondentId}`,
    `Fecha y hora: ${lastResults.timestamp}`,
    `Sexo: ${lastResults.sociodemo.sex}     Edad: ${lastResults.sociodemo.age} a√±os`,
    `Nivel educativo: ${lastResults.sociodemo.level}     Semestre: ${lastResults.sociodemo.semester}`
  ];
  datos.forEach(line => {
    doc.text(line, marginLeft, y);
    y += 5.5;
  });
  y += 8;

  // === RESULTADOS POR DIMENSI√ìN (tabla compacta) ===
  doc.setFont("helvetica", "bold");
  doc.setFontSize(11);
  doc.text("Resultados por dimensi√≥n", marginLeft, y);
  y += 8;

  const tableHeaders = ["Dimensi√≥n", "Promedio", "Nivel"];
  const colWidths = [105, 30, 45]; // ligeramente m√°s ancho para dimensi√≥n
  const tableRowHeight = 8; // m√°s compacto
  const tableStartX = marginLeft;

  // Cabecera
  doc.setFillColor(230, 240, 255);
  doc.rect(tableStartX, y, contentWidth, tableRowHeight, "F");
  doc.setFont("helvetica", "bold");
  doc.setFontSize(9.5);
  doc.text(tableHeaders[0], tableStartX + 5, y + 6);
  doc.text(tableHeaders[1], tableStartX + colWidths[0] + 5, y + 6);
  doc.text(tableHeaders[2], tableStartX + colWidths[0] + colWidths[1] + 5, y + 6);
  y += tableRowHeight;

  doc.setFont("helvetica", "normal");
  doc.setFontSize(9.5);

  lastResults.sections.forEach(sec => {
    doc.setDrawColor(180);
    doc.line(tableStartX, y, pageWidth - marginRight, y);

    doc.text(sec.name, tableStartX + 5, y + 6);
    doc.text(sec.avg.toFixed(2), tableStartX + colWidths[0] + 5, y + 6);
    doc.text(sec.level, tableStartX + colWidths[0] + colWidths[1] + 5, y + 6);

    y += tableRowHeight;
  });

  doc.line(tableStartX, y, pageWidth - marginRight, y);
  y += 10;

  // === RESULTADO GLOBAL ===
  doc.setFont("helvetica", "bold");
  doc.setFontSize(11);
  doc.text("Resultado Global", marginLeft, y);
  y += 7;

  doc.setFont("helvetica", "normal");
  doc.setFontSize(10);
  const globalText = `Promedio global: ${lastResults.globalAvg.toFixed(2)} (${lastResults.globalLevel})`;
  doc.text(globalText, marginLeft, y);
  y += 8;

  // === INTERPRETACI√ìN ===
  doc.setFont("helvetica", "bold");
  doc.setFontSize(10.5);
  doc.text("Interpretaci√≥n del resultado:", marginLeft, y);
  y += 7;

  doc.setFont("helvetica", "normal");
  doc.setFontSize(9.5);
  const desc = getGlobalDescription(lastResults.globalAvg);
  const descLines = doc.splitTextToSize(desc, contentWidth);

  const lineHeight = 5.5; // interlineado m√°s ajustado
  descLines.forEach(line => {
    doc.text(line, marginLeft, y);
    y += lineHeight;
  });

  // === PIE DE P√ÅGINA ===
  doc.setFont("helvetica", "normal");
  doc.setFontSize(9);
  doc.setTextColor(80);
  doc.text(`ID: ${lastResults.respondentId} ‚Ä¢ Generado el ${lastResults.timestamp} ‚Ä¢ P√°gina 1`, pageWidth / 2, pageHeight - marginBottom + 5, { align: "center" });

  // Guardar
  doc.save(`Resultados_EAN-IN_${lastResults.respondentId}.pdf`);
}
    pdfBtn.addEventListener("click", generatePDF);

    /* Bot√≥n "Volver a la p√°gina principal" */
    if (goHomeBtn) {
      goHomeBtn.addEventListener("click", () => {
        window.location.reload();
      });
    }

    /* =====================================
       8. PDF DEL CONSENTIMIENTO INFORMADO
       ===================================== */
    function generateConsentPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 10;
      doc.setFontSize(14);
      doc.text("Consentimiento informado EAN-IN", 10, y);
      y += 8;
      doc.setFontSize(10);
      const lines = [
        "El siguiente instrumento de autoevaluaci√≥n es parte de una investigaci√≥n educativa registrada ante la Secretar√≠a",
        "de Ciencia, Humanidades, Tecnolog√≠a e Innovaci√≥n (Folio IH-2025-I-407) por parte de la Universidad Pedag√≥gica",
        "del Estado de Sinaloa.",
        "",
        "El objetivo del cuestionario es contribuir a diagnosticar el nivel de conocimiento preliminar de los estudiantes sobre",
        "dise√±os de investigaci√≥n educativa y redacci√≥n cient√≠fica. Su participaci√≥n permitir√° contribuir al proceso de calidad",
        "en la formaci√≥n universitaria y a la toma de decisiones acad√©micas y cient√≠ficas.",
        "",
        "No se ha detectado ning√∫n riesgo que implique esta investigaci√≥n; sin embargo, si no se siente c√≥modo proporcionando",
        "alguna informaci√≥n, tiene la libertad de abandonar la investigaci√≥n antes de finalizar la contestaci√≥n del instrumento,",
        "sin que esto le afecte en lo absoluto.",
        "",
        "La contestaci√≥n de este instrumento es voluntaria y an√≥nima; no se solicita su nombre. La informaci√≥n recolectada se",
        "utilizar√° para la mejora de la calidad educativa universitaria y el desarrollo del proyecto de investigaci√≥n, as√≠ como",
        "para la diseminaci√≥n de resultados en congresos, simposios, coloquios u otros medios de publicaci√≥n o difusi√≥n.",
        "",
        "Lo √∫nico que se le pide es contestar con honestidad de acuerdo con sus conocimientos. Si est√° de acuerdo en continuar,",
        "conteste las preguntas; de lo contrario, puede abandonar este proceso sin consecuencia acad√©mica o personal.",
        "",
        "Datos del proyecto:",
        "Investigador responsable: Dr. Kristian Armando Pineda Castillo",
        "T√≠tulo del proyecto: Uso de material multimedia en formato de video para potenciar el aprendizaje cient√≠fico",
        "universitario: el aprendizaje de la investigaci√≥n educativa y la redacci√≥n cient√≠fica.",
        "Folio: IH-2025-I-407",
        "Objetivo general: Describir la forma en que el uso de material multimedia en formato de video impacta en el proceso de",
        "aprendizaje de la investigaci√≥n educativa y la redacci√≥n cient√≠fica en el contexto universitario de la UPES.",
        "Contacto: kristian.pineda@upes.edu.mx",
        "",
        "He le√≠do y comprendido la informaci√≥n anterior. Acepto participar voluntariamente en este estudio, entendiendo que mi",
        "participaci√≥n es confidencial y puedo retirarme en cualquier momento sin consecuencias."
      ];
      lines.forEach(line => {
        const split = doc.splitTextToSize(line, 190);
        split.forEach(str => {
          if (y > 280) { doc.addPage(); y = 10; }
          doc.text(str, 10, y);
          y += 5;
        });
      });
      doc.save("Consentimiento_EANIN.pdf");
    }
    if (downloadConsentBtn) {
      downloadConsentBtn.addEventListener("click", generateConsentPDF);
    }

    // Vista inicial
    onPresentationTabClick();
  </script>
</body>
</html>
